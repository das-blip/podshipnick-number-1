/**
 * ============================================================================
 * –ó–ê–î–ê–ù–ò–ï 4: –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ü–≤–µ—Ç—É –≤ HSV –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ
 * ============================================================================
 * –¶–µ–ª—å:
 *   1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å HSV-–¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
 *   2. –°–æ–∑–¥–∞—Ç—å –±–∏–Ω–∞—Ä–Ω—É—é –º–∞—Å–∫—É —á–µ—Ä–µ–∑ inRange()
 *   3. –í—ã–¥–µ–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ bitwise_and()
 * 
 * –ü–æ—á–µ–º—É HSV –ª—É—á—à–µ BGR –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏:
 *   - H (Hue) –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ü–≤–µ—Ç, –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ—Å–≤–µ—â–µ–Ω–∏—è
 *   - S (Saturation) –∏ V (Value) –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥ —è—Ä–∫–æ—Å—Ç—å
 *   - –í BGR —Ü–≤–µ—Ç —Å–º–µ—à–∞–Ω –∏–∑ 3 –∫–∞–Ω–∞–ª–æ–≤, —Å–ª–æ–∂–Ω–µ–µ –≤—ã–¥–µ–ª–∏—Ç—å
 * ============================================================================
 */

#include <opencv2/opencv.hpp>
#include <iostream>

using namespace cv;
using namespace std;

/**
 * @brief –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Ü–≤–µ—Ç–∞ –≤ HSV
 * 
 * @details
 *   HSV –¥–∏–∞–ø–∞–∑–æ–Ω—ã –≤ OpenCV:
 *   - H: 0-179 (—Ä–µ–∞–ª—å–Ω–æ 0-360¬∞, –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 2)
 *   - S: 0-255 (–Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å)
 *   - V: 0-255 (—è—Ä–∫–æ—Å—Ç—å)
 */
struct HSVRange {
    string name;    // –ù–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∞
    Scalar lower;   // –ù–∏–∂–Ω–∏–π –ø–æ—Ä–æ–≥ [H, S, V]
    Scalar upper;   // –í–µ—Ä—Ö–Ω–∏–π –ø–æ—Ä–æ–≥ [H, S, V]
};

int main() {
    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–ú–ï–†–´ ===
    VideoCapture cap(0);
    if (!cap.isOpened()) {
        cerr << "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞–º–µ—Ä—ã!" << endl;
        return -1;
    }

    // === –ù–ê–°–¢–†–û–ô–ö–ê –†–ê–ó–†–ï–®–ï–ù–ò–Ø –ö–ê–ú–ï–†–´ ===
    // –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è FPS
    cap.set(CAP_PROP_FRAME_WIDTH, 640);
    cap.set(CAP_PROP_FRAME_HEIGHT, 480);

    // === –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï HSV –î–ò–ê–ü–ê–ó–û–ù–û–í –î–õ–Ø –¶–í–ï–¢–û–í ===
    vector<HSVRange> colors = {
        // –°–∏–Ω–∏–π: H=100-140 (–≤ OpenCV), S –∏ V –æ—Ç 50 –¥–æ 255
        {"Blue",   Scalar(100, 50, 50), Scalar(140, 255, 255)},
        
        // –ö—Ä–∞—Å–Ω—ã–π: H=0-10 (–ø–µ—Ä–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω)
        {"Red",    Scalar(0, 50, 50),   Scalar(10, 255, 255)},
        
        // –ö—Ä–∞—Å–Ω—ã–π: H=170-180 (–≤—Ç–æ—Ä–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω, —Ç.–∫. –∫—Ä–∞—Å–Ω—ã–π –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ —Å–ø–µ–∫—Ç—Ä–∞)
        {"Red2",   Scalar(170, 50, 50), Scalar(180, 255, 255)},
        
        // –ó–µ–ª—ë–Ω—ã–π: H=35-85
        {"Green",  Scalar(35, 50, 50),  Scalar(85, 255, 255)},
    };

    // === –°–û–ó–î–ê–ù–ò–ï –û–ö–û–ù ===
    namedWindow("Original", WINDOW_NORMAL);
    namedWindow("Mask", WINDOW_NORMAL);
    namedWindow("Result", WINDOW_NORMAL);

    Mat frame, hsv, mask, result;
    int color_idx = 0; // –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Ü–≤–µ—Ç–∞ (0=Blue)

    cout << "‚úÖ –ó–∞–¥–∞–Ω–∏–µ 4 –∑–∞–ø—É—â–µ–Ω–æ.\n";
    cout << "üìå –ö–ª–∞–≤–∏—à–∏: 1=Blue, 2=Red, 3=Green, q=–≤—ã—Ö–æ–¥\n";

    // === –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ ===
    while (true) {
        // –ó–∞—Ö–≤–∞—Ç –∫–∞–¥—Ä–∞
        cap >> frame;
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –∫–∞–¥—Ä—ã (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–±–æ–µ–≤ –∫–∞–º–µ—Ä—ã)
        if (frame.empty()) {
            continue;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å BGR, 3 –∫–∞–Ω–∞–ª–∞)
        if (frame.type() != CV_8UC3) {
            cerr << "‚ö† –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –∫–∞–¥—Ä–∞!" << endl;
            break;
        }

        // === –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø BGR ‚Üí HSV ===
        try {
            cvtColor(frame, hsv, COLOR_BGR2HSV);
        } catch (const cv::Exception& e) {
            cerr << "‚ö† –û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: " << e.what() << endl;
            continue;
        }

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω —Ü–≤–µ—Ç–∞
        HSVRange current = colors[color_idx];
        
        // === –°–û–ó–î–ê–ù–ò–ï –ë–ò–ù–ê–†–ù–û–ô –ú–ê–°–ö–ò ===
        try {
            // –î–ª—è –∫—Ä–∞—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ –Ω—É–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–≤–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            // (–∫—Ä–∞—Å–Ω—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ 0¬∞ –∏ 360¬∞)
            if (current.name == "Red") {
                Mat mask1, mask2;
                // –ü–µ—Ä–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –∫—Ä–∞—Å–Ω–æ–≥–æ (0-10)
                inRange(hsv, colors[1].lower, colors[1].upper, mask1);
                // –í—Ç–æ—Ä–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –∫—Ä–∞—Å–Ω–æ–≥–æ (170-180)
                inRange(hsv, colors[2].lower, colors[2].upper, mask2);
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –º–∞—Å–∫–∏ (–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ò–õ–ò)
                bitwise_or(mask1, mask2, mask);
            } else {
                // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–¥–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
                inRange(hsv, current.lower, current.upper, mask);
            }

            // === –í–´–î–ï–õ–ï–ù–ò–ï –û–ë–™–ï–ö–¢–ê –ù–ê –ò–°–•–û–î–ù–û–ú –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ò ===
            // bitwise_and –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–∏–∫—Å–µ–ª–∏, –≥–¥–µ –º–∞—Å–∫–∞ = 255 (–±–µ–ª—ã–π)
            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —á—ë—Ä–Ω—ã–º–∏
            bitwise_and(frame, frame, result, mask);
        } catch (const cv::Exception& e) {
            cerr << "‚ö† –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: " << e.what() << endl;
            continue;
        }

        // === –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ===
        imshow("Original", frame);  // –ò—Å—Ö–æ–¥–Ω—ã–π –∫–∞–¥—Ä
        imshow("Mask", mask);       // –ë–∏–Ω–∞—Ä–Ω–∞—è –º–∞—Å–∫–∞ (—á—ë—Ä–Ω–æ-–±–µ–ª–∞—è)
        imshow("Result", result);   // –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç

        // === –û–ë–†–ê–ë–û–¢–ö–ê –ö–õ–ê–í–ò–® ===
        char key = waitKey(30);
        if (key == 'q' || key == 27) break; // –í—ã—Ö–æ–¥
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞
        if (key == '1') { 
            color_idx = 0; 
            cout << "üîµ –í—ã–±—Ä–∞–Ω: Blue\n"; 
        }
        if (key == '2') { 
            color_idx = 1; 
            cout << "üî¥ –í—ã–±—Ä–∞–Ω: Red\n"; 
        }
        if (key == '3') { 
            color_idx = 3; 
            cout << "üü¢ –í—ã–±—Ä–∞–Ω: Green\n"; 
        }
    }

    // === –û–°–í–û–ë–û–ñ–î–ï–ù–ò–ï –†–ï–°–£–†–°–û–í ===
    cap.release();
    destroyAllWindows();
    
    cout << "‚úÖ –ó–∞–¥–∞–Ω–∏–µ 4 –∑–∞–≤–µ—Ä—à–µ–Ω–æ.\n";
    return 0;
}